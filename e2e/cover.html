
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>resolvers: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/guicostaarantes/psi-server/graph/resolvers/mail.resolvers.go (75.0%)</option>
				
				<option value="file1">github.com/guicostaarantes/psi-server/graph/resolvers/profiles.resolvers.go (75.0%)</option>
				
				<option value="file2">github.com/guicostaarantes/psi-server/graph/resolvers/resolver.go (89.5%)</option>
				
				<option value="file3">github.com/guicostaarantes/psi-server/graph/resolvers/schedule.resolvers.go (72.7%)</option>
				
				<option value="file4">github.com/guicostaarantes/psi-server/graph/resolvers/treatments.resolvers.go (76.2%)</option>
				
				<option value="file5">github.com/guicostaarantes/psi-server/graph/resolvers/users.resolvers.go (61.3%)</option>
				
				<option value="file6">github.com/guicostaarantes/psi-server/modules/characteristics/services/get_characteristic_choices_by_id_service.go (84.0%)</option>
				
				<option value="file7">github.com/guicostaarantes/psi-server/modules/characteristics/services/get_characteristics_service.go (84.6%)</option>
				
				<option value="file8">github.com/guicostaarantes/psi-server/modules/characteristics/services/get_preferences_by_id_service.go (83.3%)</option>
				
				<option value="file9">github.com/guicostaarantes/psi-server/modules/characteristics/services/set_characteristic_choices_service.go (85.2%)</option>
				
				<option value="file10">github.com/guicostaarantes/psi-server/modules/characteristics/services/set_characteristics_service.go (81.8%)</option>
				
				<option value="file11">github.com/guicostaarantes/psi-server/modules/characteristics/services/set_preferences_service.go (81.1%)</option>
				
				<option value="file12">github.com/guicostaarantes/psi-server/modules/mails/services/process_pending_mails_service.go (78.9%)</option>
				
				<option value="file13">github.com/guicostaarantes/psi-server/modules/profiles/services/create_patient_service.go (71.4%)</option>
				
				<option value="file14">github.com/guicostaarantes/psi-server/modules/profiles/services/create_psychologist_service.go (71.4%)</option>
				
				<option value="file15">github.com/guicostaarantes/psi-server/modules/profiles/services/get_patient_by_user_id_service.go (85.7%)</option>
				
				<option value="file16">github.com/guicostaarantes/psi-server/modules/profiles/services/get_psychologist_by_user_id_service.go (71.4%)</option>
				
				<option value="file17">github.com/guicostaarantes/psi-server/modules/profiles/services/update_patient_service.go (78.6%)</option>
				
				<option value="file18">github.com/guicostaarantes/psi-server/modules/profiles/services/update_psychologist_service.go (78.6%)</option>
				
				<option value="file19">github.com/guicostaarantes/psi-server/modules/schedule/services/confirm_appointment_service.go (69.2%)</option>
				
				<option value="file20">github.com/guicostaarantes/psi-server/modules/schedule/services/deny_appointment_service.go (84.6%)</option>
				
				<option value="file21">github.com/guicostaarantes/psi-server/modules/schedule/services/get_appointments_of_patient_service.go (83.3%)</option>
				
				<option value="file22">github.com/guicostaarantes/psi-server/modules/schedule/services/get_appointments_of_psychologist_service.go (83.3%)</option>
				
				<option value="file23">github.com/guicostaarantes/psi-server/modules/schedule/services/get_availability_service.go (83.3%)</option>
				
				<option value="file24">github.com/guicostaarantes/psi-server/modules/schedule/services/propose_appointment_service.go (70.6%)</option>
				
				<option value="file25">github.com/guicostaarantes/psi-server/modules/schedule/services/set_availability_service.go (86.4%)</option>
				
				<option value="file26">github.com/guicostaarantes/psi-server/modules/treatments/services/assign_treatment_service.go (81.0%)</option>
				
				<option value="file27">github.com/guicostaarantes/psi-server/modules/treatments/services/create_treatment_service.go (75.0%)</option>
				
				<option value="file28">github.com/guicostaarantes/psi-server/modules/treatments/services/delete_treatment_service.go (0.0%)</option>
				
				<option value="file29">github.com/guicostaarantes/psi-server/modules/treatments/services/finalize_treatment_service.go (78.6%)</option>
				
				<option value="file30">github.com/guicostaarantes/psi-server/modules/treatments/services/get_patient_treatments_service.go (0.0%)</option>
				
				<option value="file31">github.com/guicostaarantes/psi-server/modules/treatments/services/get_psychologist_treatments_service.go (84.6%)</option>
				
				<option value="file32">github.com/guicostaarantes/psi-server/modules/treatments/services/interrupt_treatment_by_patient_service.go (80.0%)</option>
				
				<option value="file33">github.com/guicostaarantes/psi-server/modules/treatments/services/interrupt_treatment_by_psychologist_service.go (80.0%)</option>
				
				<option value="file34">github.com/guicostaarantes/psi-server/modules/treatments/services/update_treatment_service.go (84.6%)</option>
				
				<option value="file35">github.com/guicostaarantes/psi-server/modules/users/services/ask_reset_password_service.go (71.9%)</option>
				
				<option value="file36">github.com/guicostaarantes/psi-server/modules/users/services/authenticate_user_service.go (75.0%)</option>
				
				<option value="file37">github.com/guicostaarantes/psi-server/modules/users/services/create_user_service.go (75.0%)</option>
				
				<option value="file38">github.com/guicostaarantes/psi-server/modules/users/services/create_user_with_password_service.go (70.8%)</option>
				
				<option value="file39">github.com/guicostaarantes/psi-server/modules/users/services/get_user_by_id_service.go (71.4%)</option>
				
				<option value="file40">github.com/guicostaarantes/psi-server/modules/users/services/get_users_by_role_service.go (0.0%)</option>
				
				<option value="file41">github.com/guicostaarantes/psi-server/modules/users/services/reset_password_service.go (70.4%)</option>
				
				<option value="file42">github.com/guicostaarantes/psi-server/modules/users/services/update_user_service.go (0.0%)</option>
				
				<option value="file43">github.com/guicostaarantes/psi-server/modules/users/services/validate_user_token_service.go (72.7%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.

import (
        "context"
)

func (r *mutationResolver) ProcessPendingMail(ctx context.Context) (*bool, error) <span class="cov8" title="1">{
        serviceErr := r.ProcessPendingMailsService().Execute()

        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.

import (
        "context"
        "fmt"

        "github.com/guicostaarantes/psi-server/graph/generated"
        characteristics_models "github.com/guicostaarantes/psi-server/modules/characteristics/models"
        profiles_models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        schedule_models "github.com/guicostaarantes/psi-server/modules/schedule/models"
        "github.com/guicostaarantes/psi-server/modules/treatments/models"
)

func (r *mutationResolver) CreateOwnPatientProfile(ctx context.Context, input profiles_models.CreatePatientInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        serviceInput := &amp;profiles_models.CreatePatientInput{
                UserID:    userID,
                FullName:  input.FullName,
                LikeName:  input.LikeName,
                BirthDate: input.BirthDate,
                City:      input.City,
        }

        serviceErr := r.CreatePatientService().Execute(serviceInput)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) CreateOwnPsychologistProfile(ctx context.Context, input profiles_models.CreatePsychologistInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        serviceInput := &amp;profiles_models.CreatePsychologistInput{
                UserID:    userID,
                FullName:  input.FullName,
                LikeName:  input.LikeName,
                BirthDate: input.BirthDate,
                City:      input.City,
        }

        serviceErr := r.CreatePsychologistService().Execute(serviceInput)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) SetOwnPatientCharacteristicChoices(ctx context.Context, input []*characteristics_models.SetCharacteristicChoiceInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePatient, servicePatientErr := r.GetPatientByUserIDService().Execute(userID)
        if servicePatientErr != nil </span><span class="cov0" title="0">{
                return nil, servicePatientErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.SetCharacteristicChoicesService().Execute(servicePatient.ID, input)
        if serviceErr != nil </span><span class="cov8" title="1">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) SetOwnPatientPreferences(ctx context.Context, input []*characteristics_models.SetPreferenceInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePatient, servicePatientErr := r.GetPatientByUserIDService().Execute(userID)
        if servicePatientErr != nil </span><span class="cov0" title="0">{
                return nil, servicePatientErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.SetPreferencesService().Execute(servicePatient.ID, input)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) SetOwnPsychologistCharacteristicChoices(ctx context.Context, input []*characteristics_models.SetCharacteristicChoiceInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.SetCharacteristicChoicesService().Execute(servicePsy.ID, input)
        if serviceErr != nil </span><span class="cov8" title="1">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) SetOwnPsychologistPreferences(ctx context.Context, input []*characteristics_models.SetPreferenceInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.SetPreferencesService().Execute(servicePsy.ID, input)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) SetPatientCharacteristics(ctx context.Context, input []*characteristics_models.SetCharacteristicInput) (*bool, error) <span class="cov8" title="1">{
        serviceErr := r.SetCharacteristicsService().Execute(characteristics_models.PatientTarget, input)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) SetPsychologistCharacteristics(ctx context.Context, input []*characteristics_models.SetCharacteristicInput) (*bool, error) <span class="cov8" title="1">{
        serviceErr := r.SetCharacteristicsService().Execute(characteristics_models.PsychologistTarget, input)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) UpdateOwnPatientProfile(ctx context.Context, input profiles_models.UpdatePatientInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPatientByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.UpdatePatientService().Execute(servicePsy.ID, &amp;input)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) UpdateOwnPsychologistProfile(ctx context.Context, input profiles_models.UpdatePsychologistInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.UpdatePsychologistService().Execute(servicePsy.ID, &amp;input)
        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *patientProfileResolver) Characteristics(ctx context.Context, obj *profiles_models.Patient) ([]*characteristics_models.CharacteristicChoiceResponse, error) <span class="cov8" title="1">{
        return r.GetCharacteristicsByIDService().Execute(obj.ID)
}</span>

func (r *patientProfileResolver) Preferences(ctx context.Context, obj *profiles_models.Patient) ([]*characteristics_models.PreferenceResponse, error) <span class="cov8" title="1">{
        return r.GetPreferencesByIDService().Execute(obj.ID)
}</span>

func (r *patientProfileResolver) Treatments(ctx context.Context, obj *profiles_models.Patient) ([]*models.GetPatientTreatmentsResponse, error) <span class="cov0" title="0">{
        return r.GetPatientTreatmentsService().Execute(obj.ID)
}</span>

func (r *patientProfileResolver) Appointments(ctx context.Context, obj *profiles_models.Patient) ([]*schedule_models.Appointment, error) <span class="cov8" title="1">{
        return r.GetAppointmentsOfPatientService().Execute(obj.ID)
}</span>

func (r *psychologistProfileResolver) Characteristics(ctx context.Context, obj *profiles_models.Psychologist) ([]*characteristics_models.CharacteristicChoiceResponse, error) <span class="cov8" title="1">{
        return r.GetCharacteristicsByIDService().Execute(obj.ID)
}</span>

func (r *psychologistProfileResolver) Preferences(ctx context.Context, obj *profiles_models.Psychologist) ([]*characteristics_models.PreferenceResponse, error) <span class="cov8" title="1">{
        return r.GetPreferencesByIDService().Execute(obj.ID)
}</span>

func (r *psychologistProfileResolver) Treatments(ctx context.Context, obj *profiles_models.Psychologist) ([]*models.GetPsychologistTreatmentsResponse, error) <span class="cov8" title="1">{
        return r.GetPsychologistTreatmentsService().Execute(obj.ID)
}</span>

func (r *psychologistProfileResolver) Appointments(ctx context.Context, obj *profiles_models.Psychologist) ([]*schedule_models.Appointment, error) <span class="cov8" title="1">{
        return r.GetAppointmentsOfPsychologistService().Execute(obj.ID)
}</span>

func (r *publicPatientProfileResolver) Characteristics(ctx context.Context, obj *profiles_models.Patient) ([]*characteristics_models.CharacteristicChoiceResponse, error) <span class="cov0" title="0">{
        return r.GetCharacteristicsByIDService().Execute(obj.ID)
}</span>

func (r *publicPsychologistProfileResolver) Characteristics(ctx context.Context, obj *profiles_models.Psychologist) ([]*characteristics_models.CharacteristicChoiceResponse, error) <span class="cov0" title="0">{
        return r.GetCharacteristicsByIDService().Execute(obj.ID)
}</span>

func (r *queryResolver) GetOwnPatientProfile(ctx context.Context) (*profiles_models.Patient, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)
        return r.GetPatientByUserIDService().Execute(userID)
}</span>

func (r *queryResolver) GetOwnPsychologistProfile(ctx context.Context) (*profiles_models.Psychologist, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)
        return r.GetPsychologistByUserIDService().Execute(userID)
}</span>

func (r *queryResolver) GetPatientCharacteristics(ctx context.Context) ([]*characteristics_models.CharacteristicResponse, error) <span class="cov8" title="1">{
        return r.GetCharacteristicsService().Execute(characteristics_models.PatientTarget)
}</span>

func (r *queryResolver) GetPatientProfile(ctx context.Context, id string) (*profiles_models.Patient, error) <span class="cov0" title="0">{
        return r.GetPatientByUserIDService().Execute(id)
}</span>

func (r *queryResolver) GetPsychologistCharacteristics(ctx context.Context) ([]*characteristics_models.CharacteristicResponse, error) <span class="cov8" title="1">{
        return r.GetCharacteristicsService().Execute(characteristics_models.PsychologistTarget)
}</span>

func (r *queryResolver) GetPsychologistProfile(ctx context.Context, id string) (*profiles_models.Psychologist, error) <span class="cov0" title="0">{
        return r.GetPsychologistByUserIDService().Execute(id)
}</span>

// PatientProfile returns generated.PatientProfileResolver implementation.
func (r *Resolver) PatientProfile() generated.PatientProfileResolver <span class="cov8" title="1">{
        return &amp;patientProfileResolver{r}
}</span>

// PsychologistProfile returns generated.PsychologistProfileResolver implementation.
func (r *Resolver) PsychologistProfile() generated.PsychologistProfileResolver <span class="cov8" title="1">{
        return &amp;psychologistProfileResolver{r}
}</span>

// PublicPatientProfile returns generated.PublicPatientProfileResolver implementation.
func (r *Resolver) PublicPatientProfile() generated.PublicPatientProfileResolver <span class="cov0" title="0">{
        return &amp;publicPatientProfileResolver{r}
}</span>

// PublicPsychologistProfile returns generated.PublicPsychologistProfileResolver implementation.
func (r *Resolver) PublicPsychologistProfile() generated.PublicPsychologistProfileResolver <span class="cov0" title="0">{
        return &amp;publicPsychologistProfileResolver{r}
}</span>

type patientProfileResolver struct{ *Resolver }
type psychologistProfileResolver struct{ *Resolver }
type publicPatientProfileResolver struct{ *Resolver }
type publicPsychologistProfileResolver struct{ *Resolver }

// !!! WARNING !!!
// The code below was going to be deleted when updating resolvers. It has been copied here so you have
// one last chance to move it out of harms way if you want. There are two reasons this happens:
//  - When renaming or deleting a resolver the old code will be put in here. You can safely delete
//    it when you're done.
//  - You have helper methods in this file. Move them out to keep these resolver files clean.
func (r *patientProfileResolver) Slots(ctx context.Context, obj *profiles_models.Patient) ([]*models.GetPatientTreatmentsResponse, error) <span class="cov0" title="0">{
        panic(fmt.Errorf("not implemented"))</span>
}
func (r *psychologistProfileResolver) Slots(ctx context.Context, obj *profiles_models.Psychologist) ([]*models.GetPsychologistTreatmentsResponse, error) <span class="cov0" title="0">{
        panic(fmt.Errorf("not implemented"))</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package resolvers

import (
        characteristics_services "github.com/guicostaarantes/psi-server/modules/characteristics/services"
        mails_services "github.com/guicostaarantes/psi-server/modules/mails/services"
        profiles_services "github.com/guicostaarantes/psi-server/modules/profiles/services"
        schedule_services "github.com/guicostaarantes/psi-server/modules/schedule/services"
        treatments_services "github.com/guicostaarantes/psi-server/modules/treatments/services"
        users_services "github.com/guicostaarantes/psi-server/modules/users/services"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/hash"
        "github.com/guicostaarantes/psi-server/utils/identifier"
        "github.com/guicostaarantes/psi-server/utils/mail"
        "github.com/guicostaarantes/psi-server/utils/match"
        "github.com/guicostaarantes/psi-server/utils/serializing"
        "github.com/guicostaarantes/psi-server/utils/token"
)

// This file will not be regenerated automatically.
//
// It serves as dependency injection for your app, add any dependencies you require here.

// Resolver receives all utils and registers all services within the application
type Resolver struct {
        DatabaseUtil                            database.IDatabaseUtil
        HashUtil                                hash.IHashUtil
        IdentifierUtil                          identifier.IIdentifierUtil
        MailUtil                                mail.IMailUtil
        MatchUtil                               match.IMatchUtil
        SerializingUtil                         serializing.ISerializingUtil
        TokenUtil                               token.ITokenUtil
        SecondsLimitAvailability                int64
        SecondsMinimumAvailability              int64
        SecondsToCooldownReset                  int64
        SecondsToExpire                         int64
        SecondsToExpireReset                    int64
        askResetPasswordService                 *users_services.AskResetPasswordService
        assignTreatmentService                  *treatments_services.AssignTreatmentService
        authenticateUserService                 *users_services.AuthenticateUserService
        confirmAppointmentService               *schedule_services.ConfirmAppointmentService
        createPatientService                    *profiles_services.CreatePatientService
        createPsychologistService               *profiles_services.CreatePsychologistService
        createTreatmentService                  *treatments_services.CreateTreatmentService
        createUserService                       *users_services.CreateUserService
        createUserWithPasswordService           *users_services.CreateUserWithPasswordService
        deleteTreatmentService                  *treatments_services.DeleteTreatmentService
        denyAppointmentService                  *schedule_services.DenyAppointmentService
        finalizeTreatmentService                *treatments_services.FinalizeTreatmentService
        getAppointmentsOfPatientService         *schedule_services.GetAppointmentsOfPatientService
        getAppointmentsOfPsychologistService    *schedule_services.GetAppointmentsOfPsychologistService
        getAvailabilityService                  *schedule_services.GetAvailabilityService
        getCharacteristicsByIDService           *characteristics_services.GetCharacteristicsByIDService
        getCharacteristicsService               *characteristics_services.GetCharacteristicsService
        getPatientByUserIDService               *profiles_services.GetPatientByUserIDService
        getPatientTreatmentsService             *treatments_services.GetPatientTreatmentsService
        getPreferencesByIDService               *characteristics_services.GetPreferencesByIDService
        getPsychologistByUserIDService          *profiles_services.GetPsychologistByUserIDService
        getPsychologistTreatmentsService        *treatments_services.GetPsychologistTreatmentsService
        getUserByIDService                      *users_services.GetUserByIDService
        getUsersByRoleService                   *users_services.GetUsersByRoleService
        interruptTreatmentByPatientService      *treatments_services.InterruptTreatmentByPatientService
        interruptTreatmentByPsychologistService *treatments_services.InterruptTreatmentByPsychologistService
        processPendingMailsService              *mails_services.ProcessPendingMailsService
        proposeAppointmentService               *schedule_services.ProposeAppointmentService
        resetPasswordService                    *users_services.ResetPasswordService
        setAvailabilityService                  *schedule_services.SetAvailabilityService
        setCharacteristicChoicesService         *characteristics_services.SetCharacteristicChoicesService
        setCharacteristicsService               *characteristics_services.SetCharacteristicsService
        setPreferencesService                   *characteristics_services.SetPreferencesService
        updatePatientService                    *profiles_services.UpdatePatientService
        updatePsychologistService               *profiles_services.UpdatePsychologistService
        updateTreatmentService                  *treatments_services.UpdateTreatmentService
        updateUserService                       *users_services.UpdateUserService
        validateUserTokenService                *users_services.ValidateUserTokenService
}

// AskResetPasswordService gets or sets the service with same name
func (r *Resolver) AskResetPasswordService() *users_services.AskResetPasswordService <span class="cov8" title="1">{
        if r.askResetPasswordService == nil </span><span class="cov8" title="1">{
                r.askResetPasswordService = &amp;users_services.AskResetPasswordService{
                        DatabaseUtil:    r.DatabaseUtil,
                        IdentifierUtil:  r.IdentifierUtil,
                        TokenUtil:       r.TokenUtil,
                        SecondsToExpire: r.SecondsToExpire,
                }
        }</span>
        <span class="cov8" title="1">return r.askResetPasswordService</span>
}

// AssignTreatmentService gets or sets the service with same name
func (r *Resolver) AssignTreatmentService() *treatments_services.AssignTreatmentService <span class="cov8" title="1">{
        if r.assignTreatmentService == nil </span><span class="cov8" title="1">{
                r.assignTreatmentService = &amp;treatments_services.AssignTreatmentService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.assignTreatmentService</span>
}

// AuthenticateUserService gets or sets the service with same name
func (r *Resolver) AuthenticateUserService() *users_services.AuthenticateUserService <span class="cov8" title="1">{
        if r.authenticateUserService == nil </span><span class="cov8" title="1">{
                r.authenticateUserService = &amp;users_services.AuthenticateUserService{
                        DatabaseUtil:    r.DatabaseUtil,
                        HashUtil:        r.HashUtil,
                        SerializingUtil: r.SerializingUtil,
                        TokenUtil:       r.TokenUtil,
                        SecondsToExpire: r.SecondsToExpire,
                }
        }</span>
        <span class="cov8" title="1">return r.authenticateUserService</span>
}

// ConfirmAppointmentService gets or sets the service with same name
func (r *Resolver) ConfirmAppointmentService() *schedule_services.ConfirmAppointmentService <span class="cov8" title="1">{
        if r.confirmAppointmentService == nil </span><span class="cov8" title="1">{
                r.confirmAppointmentService = &amp;schedule_services.ConfirmAppointmentService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.confirmAppointmentService</span>
}

// CreatePatientService gets or sets the service with same name
func (r *Resolver) CreatePatientService() *profiles_services.CreatePatientService <span class="cov8" title="1">{
        if r.createPatientService == nil </span><span class="cov8" title="1">{
                r.createPatientService = &amp;profiles_services.CreatePatientService{
                        DatabaseUtil:   r.DatabaseUtil,
                        IdentifierUtil: r.IdentifierUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.createPatientService</span>
}

// CreatePsychologistService gets or sets the service with same name
func (r *Resolver) CreatePsychologistService() *profiles_services.CreatePsychologistService <span class="cov8" title="1">{
        if r.createPsychologistService == nil </span><span class="cov8" title="1">{
                r.createPsychologistService = &amp;profiles_services.CreatePsychologistService{
                        DatabaseUtil:   r.DatabaseUtil,
                        IdentifierUtil: r.IdentifierUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.createPsychologistService</span>
}

// CreateTreatmentService gets or sets the service with same name
func (r *Resolver) CreateTreatmentService() *treatments_services.CreateTreatmentService <span class="cov8" title="1">{
        if r.createTreatmentService == nil </span><span class="cov8" title="1">{
                r.createTreatmentService = &amp;treatments_services.CreateTreatmentService{
                        DatabaseUtil:   r.DatabaseUtil,
                        IdentifierUtil: r.IdentifierUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.createTreatmentService</span>
}

// CreateUserService gets or sets the service with same name
func (r *Resolver) CreateUserService() *users_services.CreateUserService <span class="cov8" title="1">{
        if r.createUserService == nil </span><span class="cov8" title="1">{
                r.createUserService = &amp;users_services.CreateUserService{
                        DatabaseUtil:    r.DatabaseUtil,
                        IdentifierUtil:  r.IdentifierUtil,
                        MatchUtil:       r.MatchUtil,
                        SerializingUtil: r.SerializingUtil,
                        TokenUtil:       r.TokenUtil,
                        SecondsToExpire: r.SecondsToExpireReset,
                }
        }</span>
        <span class="cov8" title="1">return r.createUserService</span>
}

// CreateUserWithPasswordService gets or sets the service with same name
func (r *Resolver) CreateUserWithPasswordService() *users_services.CreateUserWithPasswordService <span class="cov8" title="1">{
        if r.createUserWithPasswordService == nil </span><span class="cov8" title="1">{
                r.createUserWithPasswordService = &amp;users_services.CreateUserWithPasswordService{
                        DatabaseUtil:    r.DatabaseUtil,
                        HashUtil:        r.HashUtil,
                        IdentifierUtil:  r.IdentifierUtil,
                        MatchUtil:       r.MatchUtil,
                        SerializingUtil: r.SerializingUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.createUserWithPasswordService</span>
}

// DeleteTreatmentService gets or sets the service with same name
func (r *Resolver) DeleteTreatmentService() *treatments_services.DeleteTreatmentService <span class="cov0" title="0">{
        if r.deleteTreatmentService == nil </span><span class="cov0" title="0">{
                r.deleteTreatmentService = &amp;treatments_services.DeleteTreatmentService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov0" title="0">return r.deleteTreatmentService</span>
}

// DenyAppointmentService gets or sets the service with same name
func (r *Resolver) DenyAppointmentService() *schedule_services.DenyAppointmentService <span class="cov8" title="1">{
        if r.denyAppointmentService == nil </span><span class="cov8" title="1">{
                r.denyAppointmentService = &amp;schedule_services.DenyAppointmentService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.denyAppointmentService</span>
}

// FinalizeTreatmentService gets or sets the service with same name
func (r *Resolver) FinalizeTreatmentService() *treatments_services.FinalizeTreatmentService <span class="cov8" title="1">{
        if r.finalizeTreatmentService == nil </span><span class="cov8" title="1">{
                r.finalizeTreatmentService = &amp;treatments_services.FinalizeTreatmentService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.finalizeTreatmentService</span>
}

// GetAppointmentsOfPatientService gets or sets the service with same name
func (r *Resolver) GetAppointmentsOfPatientService() *schedule_services.GetAppointmentsOfPatientService <span class="cov8" title="1">{
        if r.getAppointmentsOfPatientService == nil </span><span class="cov8" title="1">{
                r.getAppointmentsOfPatientService = &amp;schedule_services.GetAppointmentsOfPatientService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getAppointmentsOfPatientService</span>
}

// GetAppointmentsOfPsychologistService gets or sets the service with same name
func (r *Resolver) GetAppointmentsOfPsychologistService() *schedule_services.GetAppointmentsOfPsychologistService <span class="cov8" title="1">{
        if r.getAppointmentsOfPsychologistService == nil </span><span class="cov8" title="1">{
                r.getAppointmentsOfPsychologistService = &amp;schedule_services.GetAppointmentsOfPsychologistService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getAppointmentsOfPsychologistService</span>
}

// GetAvailabilityService gets or sets the service with same name
func (r *Resolver) GetAvailabilityService() *schedule_services.GetAvailabilityService <span class="cov8" title="1">{
        if r.getAvailabilityService == nil </span><span class="cov8" title="1">{
                r.getAvailabilityService = &amp;schedule_services.GetAvailabilityService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getAvailabilityService</span>
}

// GetCharacteristicsByIDService gets or sets the service with same name
func (r *Resolver) GetCharacteristicsByIDService() *characteristics_services.GetCharacteristicsByIDService <span class="cov8" title="1">{
        if r.getCharacteristicsByIDService == nil </span><span class="cov8" title="1">{
                r.getCharacteristicsByIDService = &amp;characteristics_services.GetCharacteristicsByIDService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getCharacteristicsByIDService</span>
}

// GetCharacteristicsService gets or sets the service with same name
func (r *Resolver) GetCharacteristicsService() *characteristics_services.GetCharacteristicsService <span class="cov8" title="1">{
        if r.getCharacteristicsService == nil </span><span class="cov8" title="1">{
                r.getCharacteristicsService = &amp;characteristics_services.GetCharacteristicsService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getCharacteristicsService</span>
}

// GetPatientByUserIDService gets or sets the service with same name
func (r *Resolver) GetPatientByUserIDService() *profiles_services.GetPatientByUserIDService <span class="cov8" title="1">{
        if r.getPatientByUserIDService == nil </span><span class="cov8" title="1">{
                r.getPatientByUserIDService = &amp;profiles_services.GetPatientByUserIDService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getPatientByUserIDService</span>
}

// GetPatientTreatmentsService gets or sets the service with same name
func (r *Resolver) GetPatientTreatmentsService() *treatments_services.GetPatientTreatmentsService <span class="cov0" title="0">{
        if r.getPatientTreatmentsService == nil </span><span class="cov0" title="0">{
                r.getPatientTreatmentsService = &amp;treatments_services.GetPatientTreatmentsService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov0" title="0">return r.getPatientTreatmentsService</span>
}

// GetPreferencesByIDService gets or sets the service with same name
func (r *Resolver) GetPreferencesByIDService() *characteristics_services.GetPreferencesByIDService <span class="cov8" title="1">{
        if r.getPreferencesByIDService == nil </span><span class="cov8" title="1">{
                r.getPreferencesByIDService = &amp;characteristics_services.GetPreferencesByIDService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getPreferencesByIDService</span>
}

// GetPsychologistByUserIDService gets or sets the service with same name
func (r *Resolver) GetPsychologistByUserIDService() *profiles_services.GetPsychologistByUserIDService <span class="cov8" title="1">{
        if r.getPsychologistByUserIDService == nil </span><span class="cov8" title="1">{
                r.getPsychologistByUserIDService = &amp;profiles_services.GetPsychologistByUserIDService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getPsychologistByUserIDService</span>
}

// GetPsychologistTreatmentsService gets or sets the service with same name
func (r *Resolver) GetPsychologistTreatmentsService() *treatments_services.GetPsychologistTreatmentsService <span class="cov8" title="1">{
        if r.getPsychologistTreatmentsService == nil </span><span class="cov8" title="1">{
                r.getPsychologistTreatmentsService = &amp;treatments_services.GetPsychologistTreatmentsService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getPsychologistTreatmentsService</span>
}

// GetUsersByRoleService gets or sets the service with same name
func (r *Resolver) GetUsersByRoleService() *users_services.GetUsersByRoleService <span class="cov0" title="0">{
        if r.getUsersByRoleService == nil </span><span class="cov0" title="0">{
                r.getUsersByRoleService = &amp;users_services.GetUsersByRoleService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov0" title="0">return r.getUsersByRoleService</span>
}

// GetUserByIDService gets or sets the service with same name
func (r *Resolver) GetUserByIDService() *users_services.GetUserByIDService <span class="cov8" title="1">{
        if r.getUserByIDService == nil </span><span class="cov8" title="1">{
                r.getUserByIDService = &amp;users_services.GetUserByIDService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.getUserByIDService</span>
}

// InterruptTreatmentByPatientService gets or sets the service with same name
func (r *Resolver) InterruptTreatmentByPatientService() *treatments_services.InterruptTreatmentByPatientService <span class="cov8" title="1">{
        if r.interruptTreatmentByPatientService == nil </span><span class="cov8" title="1">{
                r.interruptTreatmentByPatientService = &amp;treatments_services.InterruptTreatmentByPatientService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.interruptTreatmentByPatientService</span>
}

// InterruptTreatmentByPsychologistService gets or sets the service with same name
func (r *Resolver) InterruptTreatmentByPsychologistService() *treatments_services.InterruptTreatmentByPsychologistService <span class="cov8" title="1">{
        if r.interruptTreatmentByPsychologistService == nil </span><span class="cov8" title="1">{
                r.interruptTreatmentByPsychologistService = &amp;treatments_services.InterruptTreatmentByPsychologistService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.interruptTreatmentByPsychologistService</span>
}

// ProposeAppointmentService gets or sets the service with same name
func (r *Resolver) ProposeAppointmentService() *schedule_services.ProposeAppointmentService <span class="cov8" title="1">{
        if r.proposeAppointmentService == nil </span><span class="cov8" title="1">{
                r.proposeAppointmentService = &amp;schedule_services.ProposeAppointmentService{
                        DatabaseUtil:   r.DatabaseUtil,
                        IdentifierUtil: r.IdentifierUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.proposeAppointmentService</span>
}

// ProcessPendingMailsService gets or sets the service with same name
func (r *Resolver) ProcessPendingMailsService() *mails_services.ProcessPendingMailsService <span class="cov8" title="1">{
        if r.processPendingMailsService == nil </span><span class="cov8" title="1">{
                r.processPendingMailsService = &amp;mails_services.ProcessPendingMailsService{
                        DatabaseUtil: r.DatabaseUtil,
                        MailUtil:     r.MailUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.processPendingMailsService</span>
}

// SetAvailabilityService gets or sets the service with same name
func (r *Resolver) SetAvailabilityService() *schedule_services.SetAvailabilityService <span class="cov8" title="1">{
        if r.setAvailabilityService == nil </span><span class="cov8" title="1">{
                r.setAvailabilityService = &amp;schedule_services.SetAvailabilityService{
                        DatabaseUtil:               r.DatabaseUtil,
                        SecondsLimitAvailability:   r.SecondsLimitAvailability,
                        SecondsMinimumAvailability: r.SecondsMinimumAvailability,
                }
        }</span>
        <span class="cov8" title="1">return r.setAvailabilityService</span>
}

// SetCharacteristicChoicesService gets or sets the service with same name
func (r *Resolver) SetCharacteristicChoicesService() *characteristics_services.SetCharacteristicChoicesService <span class="cov8" title="1">{
        if r.setCharacteristicChoicesService == nil </span><span class="cov8" title="1">{
                r.setCharacteristicChoicesService = &amp;characteristics_services.SetCharacteristicChoicesService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.setCharacteristicChoicesService</span>
}

// SetCharacteristicsService gets or sets the service with same name
func (r *Resolver) SetCharacteristicsService() *characteristics_services.SetCharacteristicsService <span class="cov8" title="1">{
        if r.setCharacteristicsService == nil </span><span class="cov8" title="1">{
                r.setCharacteristicsService = &amp;characteristics_services.SetCharacteristicsService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.setCharacteristicsService</span>
}

// SetPreferencesService gets or sets the service with same name
func (r *Resolver) SetPreferencesService() *characteristics_services.SetPreferencesService <span class="cov8" title="1">{
        if r.setPreferencesService == nil </span><span class="cov8" title="1">{
                r.setPreferencesService = &amp;characteristics_services.SetPreferencesService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.setPreferencesService</span>
}

// ResetPasswordService gets or sets the service with same name
func (r *Resolver) ResetPasswordService() *users_services.ResetPasswordService <span class="cov8" title="1">{
        if r.resetPasswordService == nil </span><span class="cov8" title="1">{
                r.resetPasswordService = &amp;users_services.ResetPasswordService{
                        DatabaseUtil: r.DatabaseUtil,
                        HashUtil:     r.HashUtil,
                        MatchUtil:    r.MatchUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.resetPasswordService</span>
}

// UpdatePatientService gets or sets the service with same name
func (r *Resolver) UpdatePatientService() *profiles_services.UpdatePatientService <span class="cov8" title="1">{
        if r.updatePatientService == nil </span><span class="cov8" title="1">{
                r.updatePatientService = &amp;profiles_services.UpdatePatientService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.updatePatientService</span>
}

// UpdatePsychologistService gets or sets the service with same name
func (r *Resolver) UpdatePsychologistService() *profiles_services.UpdatePsychologistService <span class="cov8" title="1">{
        if r.updatePsychologistService == nil </span><span class="cov8" title="1">{
                r.updatePsychologistService = &amp;profiles_services.UpdatePsychologistService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.updatePsychologistService</span>
}

// UpdateTreatmentService gets or sets the service with same name
func (r *Resolver) UpdateTreatmentService() *treatments_services.UpdateTreatmentService <span class="cov8" title="1">{
        if r.updateTreatmentService == nil </span><span class="cov8" title="1">{
                r.updateTreatmentService = &amp;treatments_services.UpdateTreatmentService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov8" title="1">return r.updateTreatmentService</span>
}

// UpdateUserService gets or sets the service with same name
func (r *Resolver) UpdateUserService() *users_services.UpdateUserService <span class="cov0" title="0">{
        if r.updateUserService == nil </span><span class="cov0" title="0">{
                r.updateUserService = &amp;users_services.UpdateUserService{
                        DatabaseUtil: r.DatabaseUtil,
                }
        }</span>
        <span class="cov0" title="0">return r.updateUserService</span>
}

// ValidateUserTokenService gets or sets the service with same name
func (r *Resolver) ValidateUserTokenService() *users_services.ValidateUserTokenService <span class="cov8" title="1">{
        if r.validateUserTokenService == nil </span><span class="cov8" title="1">{
                r.validateUserTokenService = &amp;users_services.ValidateUserTokenService{
                        DatabaseUtil:    r.DatabaseUtil,
                        SerializingUtil: r.SerializingUtil,
                        SecondsToExpire: r.SecondsToExpire,
                }
        }</span>
        <span class="cov8" title="1">return r.validateUserTokenService</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
)

func (r *mutationResolver) ConfirmAppointment(ctx context.Context, id string) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.ConfirmAppointmentService().Execute(id, servicePsy.ID)

        return nil, serviceErr</span>
}

func (r *mutationResolver) DenyAppointment(ctx context.Context, id string) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.DenyAppointmentService().Execute(id, servicePsy.ID)

        return nil, serviceErr</span>
}

func (r *mutationResolver) ProposeAppointment(ctx context.Context, input models.ProposeAppointmentInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePatient, servicePatientErr := r.GetPatientByUserIDService().Execute(userID)
        if servicePatientErr != nil </span><span class="cov0" title="0">{
                return nil, servicePatientErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.ProposeAppointmentService().Execute(servicePatient.ID, input)

        return nil, serviceErr</span>
}

func (r *mutationResolver) SetOwnAvailability(ctx context.Context, input []*models.SetAvailabilityInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.SetAvailabilityService().Execute(servicePsy.ID, input)

        return nil, serviceErr</span>
}

func (r *queryResolver) GetOwnAvailability(ctx context.Context) ([]*models.AvailabilityResponse, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">return r.GetAvailabilityService().Execute(servicePsy.ID)</span>
}

func (r *queryResolver) GetPsychologistAvailability(ctx context.Context, id string) ([]*models.AvailabilityResponse, error) <span class="cov0" title="0">{
        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(id)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov0" title="0">return r.GetAvailabilityService().Execute(servicePsy.ID)</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
)

func (r *mutationResolver) AssignTreatment(ctx context.Context, id string) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePatient, servicePatientErr := r.GetPatientByUserIDService().Execute(userID)
        if servicePatientErr != nil </span><span class="cov8" title="1">{
                return nil, servicePatientErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.AssignTreatmentService().Execute(id, servicePatient.ID)

        return nil, serviceErr</span>
}

func (r *mutationResolver) CreateOwnTreatment(ctx context.Context, input models.CreateTreatmentInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.CreateTreatmentService().Execute(servicePsy.ID, input)

        return nil, serviceErr</span>
}

func (r *mutationResolver) DeleteOwnTreatment(ctx context.Context, id string) (*bool, error) <span class="cov0" title="0">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov0" title="0">serviceErr := r.DeleteTreatmentService().Execute(id, servicePsy.ID)

        return nil, serviceErr</span>
}

func (r *mutationResolver) InterruptTreatmentByPatient(ctx context.Context, id string, reason string) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePatient, servicePatientErr := r.GetPatientByUserIDService().Execute(userID)
        if servicePatientErr != nil </span><span class="cov8" title="1">{
                return nil, servicePatientErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.InterruptTreatmentByPatientService().Execute(id, servicePatient.ID, reason)

        return nil, serviceErr</span>
}

func (r *mutationResolver) InterruptTreatmentByPsychologist(ctx context.Context, id string, reason string) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.InterruptTreatmentByPsychologistService().Execute(id, servicePsy.ID, reason)

        return nil, serviceErr</span>
}

func (r *mutationResolver) FinalizeOwnTreatment(ctx context.Context, id string) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.FinalizeTreatmentService().Execute(id, servicePsy.ID)

        return nil, serviceErr</span>
}

func (r *mutationResolver) UpdateOwnTreatment(ctx context.Context, id string, input models.UpdateTreatmentInput) (*bool, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)

        servicePsy, servicePsyErr := r.GetPsychologistByUserIDService().Execute(userID)
        if servicePsyErr != nil </span><span class="cov0" title="0">{
                return nil, servicePsyErr
        }</span>

        <span class="cov8" title="1">serviceErr := r.UpdateTreatmentService().Execute(id, servicePsy.ID, input)

        return nil, serviceErr</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.

import (
        "context"

        generated1 "github.com/guicostaarantes/psi-server/graph/generated"
        users_models "github.com/guicostaarantes/psi-server/modules/users/models"
)

func (r *mutationResolver) AskResetPassword(ctx context.Context, email string) (*bool, error) <span class="cov8" title="1">{
        serviceErr := r.AskResetPasswordService().Execute(email)

        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) CreatePatientUser(ctx context.Context, input users_models.CreateUserInput) (*bool, error) <span class="cov8" title="1">{
        serviceErr := r.CreateUserService().Execute(&amp;users_models.CreateUserInput{
                Email: input.Email,
                Role:  "PATIENT",
        })

        if serviceErr != nil </span><span class="cov8" title="1">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) CreatePsychologistUser(ctx context.Context, input users_models.CreateUserInput) (*bool, error) <span class="cov8" title="1">{
        serviceErr := r.CreateUserService().Execute(&amp;users_models.CreateUserInput{
                Email: input.Email,
                Role:  "PSYCHOLOGIST",
        })

        if serviceErr != nil </span><span class="cov8" title="1">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) CreateUserWithPassword(ctx context.Context, input users_models.CreateUserWithPasswordInput) (*bool, error) <span class="cov0" title="0">{
        serviceErr := r.CreateUserWithPasswordService().Execute(&amp;users_models.CreateUserWithPasswordInput{
                Email:    input.Email,
                Password: input.Password,
                Role:     input.Role,
        })

        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov0" title="0">return nil, nil</span>
}

func (r *mutationResolver) ResetPassword(ctx context.Context, input users_models.ResetPasswordInput) (*bool, error) <span class="cov8" title="1">{
        serviceErr := r.ResetPasswordService().Execute(&amp;users_models.ResetPasswordInput{
                Token:    input.Token,
                Password: input.Password,
        })

        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov8" title="1">return nil, nil</span>
}

func (r *mutationResolver) UpdateUser(ctx context.Context, id string, input users_models.UpdateUserInput) (*bool, error) <span class="cov0" title="0">{
        serviceErr := r.UpdateUserService().Execute(id, &amp;input)

        if serviceErr != nil </span><span class="cov0" title="0">{
                return nil, serviceErr
        }</span>

        <span class="cov0" title="0">return nil, nil</span>
}

func (r *queryResolver) AuthenticateUser(ctx context.Context, input users_models.AuthenticateUserInput) (*users_models.Authentication, error) <span class="cov8" title="1">{
        return r.AuthenticateUserService().Execute(&amp;users_models.AuthenticateUserInput{
                Email:     input.Email,
                Password:  input.Password,
                IPAddress: input.IPAddress,
        })
}</span>

func (r *queryResolver) GetOwnUser(ctx context.Context) (*users_models.User, error) <span class="cov8" title="1">{
        userID := ctx.Value("userID").(string)
        return r.GetUserByIDService().Execute(userID)
}</span>

func (r *queryResolver) GetUser(ctx context.Context, id string) (*users_models.User, error) <span class="cov0" title="0">{
        return r.GetUserByIDService().Execute(id)
}</span>

func (r *queryResolver) ListUsersByRole(ctx context.Context, role users_models.Role) ([]*users_models.User, error) <span class="cov0" title="0">{
        return r.GetUsersByRoleService().Execute(string(role))
}</span>

// Mutation returns generated1.MutationResolver implementation.
func (r *Resolver) Mutation() generated1.MutationResolver <span class="cov8" title="1">{ return &amp;mutationResolver{r} }</span>

// Query returns generated1.QueryResolver implementation.
func (r *Resolver) Query() generated1.QueryResolver <span class="cov8" title="1">{ return &amp;queryResolver{r} }</span>

type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
</pre>
		
		<pre class="file" id="file6" style="display: none">package services

import (
        "context"
        "strings"

        "github.com/guicostaarantes/psi-server/modules/characteristics/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetCharacteristicsByIDService is a service that gets the characteristics of a profile based on its id
type GetCharacteristicsByIDService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetCharacteristicsByIDService) Execute(id string) ([]*models.CharacteristicChoiceResponse, error) <span class="cov8" title="1">{

        characteristics := []*models.CharacteristicChoiceResponse{}

        charCursor, findErr := s.DatabaseUtil.FindMany("psi_db", "characteristics", map[string]interface{}{})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">defer charCursor.Close(context.Background())

        for charCursor.Next(context.Background()) </span><span class="cov8" title="1">{
                characteristic := models.Characteristic{}

                decodeErr := charCursor.Decode(&amp;characteristic)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">characteristicResponse := models.CharacteristicChoiceResponse{
                        Name:           characteristic.Name,
                        Type:           characteristic.Type,
                        SelectedValues: []string{},
                        PossibleValues: strings.Split(characteristic.PossibleValues, ","),
                }

                characteristics = append(characteristics, &amp;characteristicResponse)</span>
        }

        <span class="cov8" title="1">choiceCursor, findErr := s.DatabaseUtil.FindMany("psi_db", "characteristic_choices", map[string]interface{}{"profileId": id})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">defer choiceCursor.Close(context.Background())

        for choiceCursor.Next(context.Background()) </span><span class="cov8" title="1">{
                choice := models.CharacteristicChoice{}

                decodeErr := choiceCursor.Decode(&amp;choice)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">for _, char := range characteristics </span><span class="cov8" title="1">{
                        if char.Name == choice.CharacteristicName </span><span class="cov8" title="1">{
                                char.SelectedValues = append(char.SelectedValues, choice.SelectedValue)
                        }</span>
                }
        }

        <span class="cov8" title="1">return characteristics, nil</span>

}
</pre>
		
		<pre class="file" id="file7" style="display: none">package services

import (
        "context"
        "strings"

        "github.com/guicostaarantes/psi-server/modules/characteristics/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetCharacteristicsService is a service that gets all possible characteristic based on the target
type GetCharacteristicsService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetCharacteristicsService) Execute(target models.CharacteristicTarget) ([]*models.CharacteristicResponse, error) <span class="cov8" title="1">{

        characteristics := []*models.CharacteristicResponse{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "characteristics", map[string]interface{}{"target": string(target)})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{
                characteristic := models.Characteristic{}

                decodeErr := cursor.Decode(&amp;characteristic)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">characteristicResponse := models.CharacteristicResponse{
                        Name:           characteristic.Name,
                        Type:           characteristic.Type,
                        PossibleValues: strings.Split(characteristic.PossibleValues, ","),
                }

                characteristics = append(characteristics, &amp;characteristicResponse)</span>
        }

        <span class="cov8" title="1">return characteristics, nil</span>

}
</pre>
		
		<pre class="file" id="file8" style="display: none">package services

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/characteristics/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetPreferencesByIDService is a service that gets the preferences of a profile based on its id
type GetPreferencesByIDService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetPreferencesByIDService) Execute(id string) ([]*models.PreferenceResponse, error) <span class="cov8" title="1">{

        preferences := []*models.PreferenceResponse{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "preferences", map[string]interface{}{"profileId": id})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{
                preference := models.PreferenceResponse{}

                decodeErr := cursor.Decode(&amp;preference)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">preferences = append(preferences, &amp;preference)</span>
        }

        <span class="cov8" title="1">return preferences, nil</span>

}
</pre>
		
		<pre class="file" id="file9" style="display: none">package services

import (
        "context"
        "errors"
        "strings"

        "github.com/guicostaarantes/psi-server/modules/characteristics/models"
        profiles_models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// SetCharacteristicChoicesService is a service that assigns a characteristic to a patient profile
type SetCharacteristicChoicesService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s SetCharacteristicChoicesService) Execute(id string, input []*models.SetCharacteristicChoiceInput) error <span class="cov8" title="1">{

        var target models.CharacteristicTarget

        psy := profiles_models.Psychologist{}
        pat := profiles_models.Patient{}
        findErr := s.DatabaseUtil.FindOne("psi_db", "patients", map[string]interface{}{"id": id}, &amp;pat)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>
        <span class="cov8" title="1">if pat.ID != "" </span><span class="cov8" title="1">{
                target = models.PatientTarget
        }</span> else<span class="cov8" title="1"> {
                findErr = s.DatabaseUtil.FindOne("psi_db", "psychologists", map[string]interface{}{"id": id}, &amp;psy)
                if findErr != nil </span><span class="cov0" title="0">{
                        return findErr
                }</span>
                <span class="cov8" title="1">if psy.ID != "" </span><span class="cov8" title="1">{
                        target = models.PsychologistTarget
                }</span> else<span class="cov0" title="0"> {
                        return errors.New("resource not found")
                }</span>
        }

        <span class="cov8" title="1">choices := []interface{}{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "characteristics", map[string]interface{}{"target": string(target)})
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{
                characteristic := models.Characteristic{}

                decodeErr := cursor.Decode(&amp;characteristic)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return decodeErr
                }</span>

                <span class="cov8" title="1">for _, i := range input </span><span class="cov8" title="1">{

                        if characteristic.Name == i.CharacteristicName </span><span class="cov8" title="1">{

                                if characteristic.Type == models.Boolean </span><span class="cov8" title="1">{

                                        if len(i.SelectedValues) != 1 || (i.SelectedValues[0] != "true" &amp;&amp; i.SelectedValues[0] != "false") </span><span class="cov8" title="1">{
                                                return errors.New("characteristic '" + characteristic.Name + "' must be either true or false")
                                        }</span>

                                        <span class="cov8" title="1">choices = append(choices, models.CharacteristicChoice{
                                                ProfileID:          id,
                                                CharacteristicName: i.CharacteristicName,
                                                SelectedValue:      i.SelectedValues[0],
                                        })

                                        continue</span>

                                }

                                <span class="cov8" title="1">if characteristic.Type == models.Single </span><span class="cov8" title="1">{

                                        if len(i.SelectedValues) != 1 </span><span class="cov8" title="1">{
                                                return errors.New("characteristic '" + characteristic.Name + "' needs exactly one value")
                                        }</span>

                                        <span class="cov8" title="1">possibleValues := strings.Split(characteristic.PossibleValues, ",")

                                        var valueExists = false
                                        for _, posValue := range possibleValues </span><span class="cov8" title="1">{
                                                if posValue == i.SelectedValues[0] </span><span class="cov8" title="1">{
                                                        valueExists = true
                                                }</span>
                                        }

                                        <span class="cov8" title="1">if !valueExists </span><span class="cov0" title="0">{
                                                return errors.New("option '" + i.SelectedValues[0] + "' is not possible in characteristic " + i.CharacteristicName)
                                        }</span>

                                        <span class="cov8" title="1">choices = append(choices, models.CharacteristicChoice{
                                                ProfileID:          id,
                                                CharacteristicName: i.CharacteristicName,
                                                SelectedValue:      i.SelectedValues[0],
                                        })

                                        continue</span>

                                }

                                <span class="cov8" title="1">if characteristic.Type == models.Multiple </span><span class="cov8" title="1">{

                                        possibleValues := strings.Split(characteristic.PossibleValues, ",")

                                        for _, value := range i.SelectedValues </span><span class="cov8" title="1">{
                                                var valueExists = false
                                                for _, posValue := range possibleValues </span><span class="cov8" title="1">{
                                                        if posValue == value </span><span class="cov8" title="1">{
                                                                valueExists = true
                                                        }</span>
                                                }
                                                <span class="cov8" title="1">if !valueExists </span><span class="cov0" title="0">{
                                                        return errors.New("option '" + value + "' is not possible in characteristic " + i.CharacteristicName)
                                                }</span>

                                                <span class="cov8" title="1">choices = append(choices, models.CharacteristicChoice{
                                                        ProfileID:          id,
                                                        CharacteristicName: i.CharacteristicName,
                                                        SelectedValue:      value,
                                                })</span>
                                        }

                                        <span class="cov8" title="1">continue</span>

                                }

                        }

                }

        }

        <span class="cov8" title="1">deleteErr := s.DatabaseUtil.DeleteMany("psi_db", "characteristic_choices", map[string]interface{}{"profileId": id})
        if deleteErr != nil </span><span class="cov0" title="0">{
                return deleteErr
        }</span>

        <span class="cov8" title="1">writeErr := s.DatabaseUtil.InsertMany("psi_db", "characteristic_choices", choices)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file10" style="display: none">package services

import (
        "strings"

        "github.com/guicostaarantes/psi-server/modules/characteristics/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// SetCharacteristicsService is a service that sets all possible patient characteristics
type SetCharacteristicsService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s SetCharacteristicsService) Execute(target models.CharacteristicTarget, input []*models.SetCharacteristicInput) error <span class="cov8" title="1">{

        newCharacteristics := []interface{}{}

        for _, char := range input </span><span class="cov8" title="1">{
                characteristic := models.Characteristic{
                        Name:           char.Name,
                        Type:           char.Type,
                        Target:         target,
                        PossibleValues: strings.Join(char.PossibleValues, ","),
                }

                newCharacteristics = append(newCharacteristics, characteristic)
        }</span>

        <span class="cov8" title="1">deleteErr := s.DatabaseUtil.DeleteMany("psi_db", "characteristics", map[string]interface{}{"target": string(target)})
        if deleteErr != nil </span><span class="cov0" title="0">{
                return deleteErr
        }</span>

        <span class="cov8" title="1">writeErr := s.DatabaseUtil.InsertMany("psi_db", "characteristics", newCharacteristics)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file11" style="display: none">package services

import (
        "context"
        "errors"
        "strings"

        "github.com/guicostaarantes/psi-server/modules/characteristics/models"
        profiles_models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// SetPreferencesService is a service that allows a profile to submit their preferences
type SetPreferencesService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s SetPreferencesService) Execute(id string, input []*models.SetPreferenceInput) error <span class="cov8" title="1">{

        var target models.CharacteristicTarget

        psy := profiles_models.Psychologist{}
        pat := profiles_models.Patient{}
        findErr := s.DatabaseUtil.FindOne("psi_db", "patients", map[string]interface{}{"id": id}, &amp;pat)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>
        <span class="cov8" title="1">if pat.ID != "" </span><span class="cov8" title="1">{
                target = models.PsychologistTarget
        }</span> else<span class="cov8" title="1"> {
                findErr = s.DatabaseUtil.FindOne("psi_db", "psychologists", map[string]interface{}{"id": id}, &amp;psy)
                if findErr != nil </span><span class="cov0" title="0">{
                        return findErr
                }</span>
                <span class="cov8" title="1">if psy.ID != "" </span><span class="cov8" title="1">{
                        target = models.PatientTarget
                }</span> else<span class="cov0" title="0"> {
                        return errors.New("resource not found")
                }</span>
        }

        <span class="cov8" title="1">preferences := []interface{}{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "characteristics", map[string]interface{}{"target": string(target)})
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{

                characteristic := models.Characteristic{}

                decodeErr := cursor.Decode(&amp;characteristic)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return decodeErr
                }</span>

                <span class="cov8" title="1">for _, i := range input </span><span class="cov8" title="1">{
                        if characteristic.Name == i.CharacteristicName </span><span class="cov8" title="1">{
                                possibleValues := strings.Split(characteristic.PossibleValues, ",")
                                for _, p := range possibleValues </span><span class="cov8" title="1">{
                                        if i.SelectedValue == p &amp;&amp; i.Weight != 0 </span><span class="cov8" title="1">{
                                                preferences = append(preferences, models.Preference{
                                                        ProfileID:          id,
                                                        CharacteristicName: i.CharacteristicName,
                                                        SelectedValue:      i.SelectedValue,
                                                        Weight:             i.Weight,
                                                })
                                        }</span>
                                }
                        }
                }

        }

        <span class="cov8" title="1">deleteErr := s.DatabaseUtil.DeleteMany("psi_db", "preferences", map[string]interface{}{"profileId": id})
        if deleteErr != nil </span><span class="cov0" title="0">{
                return deleteErr
        }</span>

        <span class="cov8" title="1">writeErr := s.DatabaseUtil.InsertMany("psi_db", "preferences", preferences)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file12" style="display: none">package mails_services

import (
        "context"
        "time"

        mails_models "github.com/guicostaarantes/psi-server/modules/mails/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/mail"
)

// ProcessPendingMailsService is a service that checks the mails table and processes pending messages
type ProcessPendingMailsService struct {
        DatabaseUtil database.IDatabaseUtil
        MailUtil     mail.IMailUtil
}

// Execute is the method that runs the business logic of the service
func (p ProcessPendingMailsService) Execute() error <span class="cov8" title="1">{

        ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)

        defer cancel()

        cursor, findErr := p.DatabaseUtil.FindMany("psi_db", "mails", map[string]interface{}{"processed": false})
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(ctx)

        for cursor.Next(ctx) </span><span class="cov8" title="1">{

                dbmsg := &amp;mails_models.TransientMailMessage{}

                decodeErr := cursor.Decode(&amp;dbmsg)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return decodeErr
                }</span>

                <span class="cov8" title="1">sendErr := p.MailUtil.Send(mail.Message{
                        FromAddress: dbmsg.FromAddress,
                        FromName:    dbmsg.FromName,
                        To:          dbmsg.To,
                        Cc:          dbmsg.Cc,
                        Cco:         dbmsg.Cco,
                        Subject:     dbmsg.Subject,
                        HTML:        dbmsg.Html,
                })
                if sendErr != nil </span><span class="cov0" title="0">{
                        return sendErr
                }</span>

                <span class="cov8" title="1">dbmsg.Processed = true

                updateErr := p.DatabaseUtil.UpdateOne("psi_db", "mails", map[string]interface{}{"id": dbmsg.ID}, dbmsg)
                if updateErr != nil </span><span class="cov0" title="0">{
                        return updateErr
                }</span>

        }

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file13" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
)

// CreatePatientService is a service that creates a patient profile
type CreatePatientService struct {
        DatabaseUtil   database.IDatabaseUtil
        IdentifierUtil identifier.IIdentifierUtil
}

// Execute is the method that runs the business logic of the service
func (s CreatePatientService) Execute(input *models.CreatePatientInput) error <span class="cov8" title="1">{

        patientWithSameUserID := models.Patient{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "patients", map[string]interface{}{"userId": input.UserID}, &amp;patientWithSameUserID)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if patientWithSameUserID.ID != "" </span><span class="cov0" title="0">{
                return errors.New("cannot create two patient profiles for the same user")
        }</span>

        <span class="cov8" title="1">_, patientID, patientIDErr := s.IdentifierUtil.GenerateIdentifier()
        if patientIDErr != nil </span><span class="cov0" title="0">{
                return patientIDErr
        }</span>

        <span class="cov8" title="1">patient := &amp;models.Patient{
                ID:        patientID,
                UserID:    input.UserID,
                FullName:  input.FullName,
                LikeName:  input.LikeName,
                BirthDate: input.BirthDate,
                City:      input.City,
        }

        writeErr := s.DatabaseUtil.InsertOne("psi_db", "patients", patient)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file14" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
)

// CreatePsychologistService is a service that creates a psychologist profile
type CreatePsychologistService struct {
        DatabaseUtil   database.IDatabaseUtil
        IdentifierUtil identifier.IIdentifierUtil
}

// Execute is the method that runs the business logic of the service
func (s CreatePsychologistService) Execute(input *models.CreatePsychologistInput) error <span class="cov8" title="1">{

        psyWithSameUserID := models.Psychologist{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "psychologists", map[string]interface{}{"userId": input.UserID}, &amp;psyWithSameUserID)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if psyWithSameUserID.ID != "" </span><span class="cov0" title="0">{
                return errors.New("cannot create two psychologist profiles for the same user")
        }</span>

        <span class="cov8" title="1">_, psyID, psyIDErr := s.IdentifierUtil.GenerateIdentifier()
        if psyIDErr != nil </span><span class="cov0" title="0">{
                return psyIDErr
        }</span>

        <span class="cov8" title="1">psy := &amp;models.Psychologist{
                ID:        psyID,
                UserID:    input.UserID,
                FullName:  input.FullName,
                LikeName:  input.LikeName,
                BirthDate: input.BirthDate,
                City:      input.City,
        }

        writeErr := s.DatabaseUtil.InsertOne("psi_db", "psychologists", psy)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file15" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetPatientByUserIDService is a service that gets the patient profile based on UserID
type GetPatientByUserIDService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetPatientByUserIDService) Execute(id string) (*models.Patient, error) <span class="cov8" title="1">{

        patient := &amp;models.Patient{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "patients", map[string]interface{}{"userId": id}, patient)
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">if patient.ID == "" </span><span class="cov8" title="1">{
                return nil, errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">return patient, nil</span>

}
</pre>
		
		<pre class="file" id="file16" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetPsychologistByUserIDService is a service that gets the psychologist profile based on UserID
type GetPsychologistByUserIDService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetPsychologistByUserIDService) Execute(id string) (*models.Psychologist, error) <span class="cov8" title="1">{

        psy := &amp;models.Psychologist{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "psychologists", map[string]interface{}{"userId": id}, psy)
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">if psy.ID == "" </span><span class="cov0" title="0">{
                return nil, errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">return psy, nil</span>

}
</pre>
		
		<pre class="file" id="file17" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// UpdatePatientService is a service that edits a patient profile
type UpdatePatientService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s UpdatePatientService) Execute(id string, input *models.UpdatePatientInput) error <span class="cov8" title="1">{

        patient := models.Patient{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "patients", map[string]interface{}{"id": id}, &amp;patient)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if patient.ID == "" </span><span class="cov0" title="0">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">patient.FullName = input.FullName
        patient.LikeName = input.LikeName
        patient.BirthDate = input.BirthDate
        patient.City = input.City

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "patients", map[string]interface{}{"id": id}, patient)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file18" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/profiles/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// UpdatePsychologistService is a service that edits a psychologist profile
type UpdatePsychologistService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s UpdatePsychologistService) Execute(id string, input *models.UpdatePsychologistInput) error <span class="cov8" title="1">{

        psy := models.Psychologist{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "psychologists", map[string]interface{}{"id": id}, &amp;psy)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if psy.ID == "" </span><span class="cov0" title="0">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">psy.FullName = input.FullName
        psy.LikeName = input.LikeName
        psy.BirthDate = input.BirthDate
        psy.City = input.City

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "psychologists", map[string]interface{}{"id": id}, psy)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file19" style="display: none">package services

import (
        "errors"
        "fmt"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// ConfirmAppointmentService is a service that the psychologist will use to deny an appointment made for him
type ConfirmAppointmentService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s ConfirmAppointmentService) Execute(id string, psychologistID string) error <span class="cov8" title="1">{

        appointment := models.Appointment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "appointments", map[string]interface{}{"id": id, "psychologistId": psychologistID}, &amp;appointment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if appointment.ID == "" </span><span class="cov0" title="0">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">if appointment.Status != models.Proposed </span><span class="cov0" title="0">{
                return fmt.Errorf("appointments can only be confirmed if their current status is PROPOSED. current status is %s", string(appointment.Status))
        }</span>

        <span class="cov8" title="1">appointment.Status = models.Confirmed

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "appointments", map[string]interface{}{"id": id}, appointment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file20" style="display: none">package services

import (
        "errors"
        "fmt"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// DenyAppointmentService is a service that the psychologist will use to deny an appointment made for him
type DenyAppointmentService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s DenyAppointmentService) Execute(id string, psychologistID string) error <span class="cov8" title="1">{

        appointment := models.Appointment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "appointments", map[string]interface{}{"id": id, "psychologistId": psychologistID}, &amp;appointment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if appointment.ID == "" </span><span class="cov8" title="1">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">if appointment.Status != models.Proposed </span><span class="cov8" title="1">{
                return fmt.Errorf("appointments can only be denied if their current status is PROPOSED. current status is %s", string(appointment.Status))
        }</span>

        <span class="cov8" title="1">appointment.Status = models.Denied

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "appointments", map[string]interface{}{"id": id}, appointment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file21" style="display: none">package services

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetAppointmentsOfPatientService is a service that the patient will use to retrieve their appointments
type GetAppointmentsOfPatientService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetAppointmentsOfPatientService) Execute(patientID string) ([]*models.Appointment, error) <span class="cov8" title="1">{

        appointments := []*models.Appointment{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "appointments", map[string]interface{}{"patientId": patientID})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{
                appointment := models.Appointment{}

                decodeErr := cursor.Decode(&amp;appointment)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">appointments = append(appointments, &amp;appointment)</span>

        }

        <span class="cov8" title="1">return appointments, nil</span>

}
</pre>
		
		<pre class="file" id="file22" style="display: none">package services

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetAppointmentsOfPsychologistService is a service that the psychologist will use to retrieve their appointments
type GetAppointmentsOfPsychologistService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetAppointmentsOfPsychologistService) Execute(psychologistID string) ([]*models.Appointment, error) <span class="cov8" title="1">{

        appointments := []*models.Appointment{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "appointments", map[string]interface{}{"psychologistId": psychologistID})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{
                appointment := models.Appointment{}

                decodeErr := cursor.Decode(&amp;appointment)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">appointments = append(appointments, &amp;appointment)</span>

        }

        <span class="cov8" title="1">return appointments, nil</span>

}
</pre>
		
		<pre class="file" id="file23" style="display: none">package services

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetAvailabilityService is a service that gets all the availabities for the user within a specific period
type GetAvailabilityService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetAvailabilityService) Execute(id string) ([]*models.AvailabilityResponse, error) <span class="cov8" title="1">{

        availabilities := []*models.AvailabilityResponse{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "availabilities", map[string]interface{}{"psychologistId": id})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{
                availability := models.AvailabilityResponse{}

                decodeErr := cursor.Decode(&amp;availability)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">availabilities = append(availabilities, &amp;availability)</span>

        }

        <span class="cov8" title="1">return availabilities, nil</span>

}
</pre>
		
		<pre class="file" id="file24" style="display: none">package services

import (
        "context"
        "errors"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
        treatments_models "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
)

// ProposeAppointmentService is a service that the patient will use to ask the psychologist for an appointment
type ProposeAppointmentService struct {
        DatabaseUtil   database.IDatabaseUtil
        IdentifierUtil identifier.IIdentifierUtil
}

// Execute is the method that runs the business logic of the service
func (s ProposeAppointmentService) Execute(patientID string, input models.ProposeAppointmentInput) error <span class="cov8" title="1">{

        treatment := treatments_models.Treatment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"id": input.TreatmentID, "patientId": patientID, "status": string(treatments_models.Active)}, &amp;treatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if treatment.ID == "" </span><span class="cov8" title="1">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">otherAppointment := models.Appointment{}

        findErr = s.DatabaseUtil.FindOne("psi_db", "appointments", map[string]interface{}{"patientId": patientID, "status": string(models.Proposed)}, &amp;otherAppointment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if otherAppointment.ID != "" </span><span class="cov8" title="1">{
                return errors.New("patient already has an appointment with status PROPOSED")
        }</span>

        <span class="cov8" title="1">end := input.Start + treatment.Duration

        isAvailable := false

        avalCursor, findAvalErr := s.DatabaseUtil.FindMany("psi_db", "availabilities", map[string]interface{}{"psychologistId": treatment.PsychologistID})
        if findAvalErr != nil </span><span class="cov0" title="0">{
                return findAvalErr
        }</span>

        <span class="cov8" title="1">defer avalCursor.Close(context.Background())

        for avalCursor.Next(context.Background()) </span><span class="cov8" title="1">{

                aval := models.Availability{}

                decodeErr := avalCursor.Decode(&amp;aval)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return decodeErr
                }</span>

                <span class="cov8" title="1">if aval.Start &lt;= input.Start &amp;&amp; aval.End &gt;= end </span><span class="cov8" title="1">{
                        isAvailable = true
                        break</span>
                }

        }

        <span class="cov8" title="1">if !isAvailable </span><span class="cov8" title="1">{
                return errors.New("the psychologist is not available during the requested time slot")
        }</span>

        <span class="cov8" title="1">isClash := false

        clashCursor, findClashErr := s.DatabaseUtil.FindMany("psi_db", "appointments", map[string]interface{}{"psychologistId": treatment.PsychologistID, "status": string(models.Confirmed)})
        if findClashErr != nil </span><span class="cov0" title="0">{
                return findClashErr
        }</span>

        <span class="cov8" title="1">defer clashCursor.Close(context.Background())

        for clashCursor.Next(context.Background()) </span><span class="cov0" title="0">{

                appointment := models.Appointment{}

                decodeErr := clashCursor.Decode(&amp;appointment)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return decodeErr
                }</span>

                <span class="cov0" title="0">if appointment.End &gt; input.Start &amp;&amp; appointment.Start &lt; end </span><span class="cov0" title="0">{
                        isClash = true
                        break</span>
                }

        }

        <span class="cov8" title="1">if isClash </span><span class="cov0" title="0">{
                return errors.New("the psychologist is not available during the requested time slot")
        }</span>

        <span class="cov8" title="1">_, appoID, appoIDErr := s.IdentifierUtil.GenerateIdentifier()
        if appoIDErr != nil </span><span class="cov0" title="0">{
                return appoIDErr
        }</span>

        <span class="cov8" title="1">newAppointment := models.Appointment{
                ID:             appoID,
                TreatmentID:    input.TreatmentID,
                PatientID:      treatment.PatientID,
                PsychologistID: treatment.PsychologistID,
                Start:          input.Start,
                End:            end,
                Price:          treatment.Price,
                Status:         models.Proposed,
        }

        writeErr := s.DatabaseUtil.InsertOne("psi_db", "appointments", newAppointment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file25" style="display: none">package services

import (
        "fmt"
        "sort"
        "time"

        "github.com/guicostaarantes/psi-server/modules/schedule/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// SetAvailabilityService is a service that sets the availabities for a psychologist
type SetAvailabilityService struct {
        DatabaseUtil               database.IDatabaseUtil
        SecondsLimitAvailability   int64
        SecondsMinimumAvailability int64
}

// Execute is the method that runs the business logic of the service
func (s SetAvailabilityService) Execute(id string, input []*models.SetAvailabilityInput) error <span class="cov8" title="1">{

        newAvailabilities := []interface{}{}

        sort.SliceStable(input, func(i, j int) bool </span><span class="cov8" title="1">{
                return input[i].Start &lt; input[j].Start
        }</span>)

        <span class="cov8" title="1">for key, aval := range input </span><span class="cov8" title="1">{

                now := time.Now()

                if key == 0 &amp;&amp; aval.Start &lt; now.Unix() </span><span class="cov8" title="1">{
                        return fmt.Errorf("availabilities must not start in the past: one availability starting at %d, current time is %d", aval.Start, now.Unix())
                }</span>

                <span class="cov8" title="1">if key &gt; 0 &amp;&amp; aval.Start &lt;= input[key-1].End </span><span class="cov0" title="0">{
                        return fmt.Errorf("availabilities must not clash: two or more availabilities include the timestamp %d", aval.Start)
                }</span>

                <span class="cov8" title="1">if aval.End &gt; now.Add(time.Second*time.Duration(s.SecondsLimitAvailability)).Unix() </span><span class="cov8" title="1">{
                        return fmt.Errorf("availabilities must not finish later than %d seconds from now: one availability ending at %d, limit time is %d", s.SecondsLimitAvailability, aval.End, now.Add(time.Second*time.Duration(s.SecondsLimitAvailability)).Unix())
                }</span>

                <span class="cov8" title="1">if aval.Start+s.SecondsMinimumAvailability &gt; aval.End </span><span class="cov8" title="1">{
                        return fmt.Errorf("availabilities must last at least %d seconds: one availability starting at %d, ending at %d", s.SecondsMinimumAvailability, aval.Start, aval.End)
                }</span>

                <span class="cov8" title="1">newAval := models.Availability{
                        PsychologistID: id,
                        Start:          aval.Start,
                        End:            aval.End,
                }

                newAvailabilities = append(newAvailabilities, newAval)</span>

        }

        <span class="cov8" title="1">deleteErr := s.DatabaseUtil.DeleteMany("psi_db", "availabilities", map[string]interface{}{"psychologistId": id})
        if deleteErr != nil </span><span class="cov0" title="0">{
                return deleteErr
        }</span>

        <span class="cov8" title="1">writeErr := s.DatabaseUtil.InsertMany("psi_db", "availabilities", newAvailabilities)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file26" style="display: none">package services

import (
        "errors"
        "fmt"
        "time"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// AssignTreatmentService is a service that assigns a patient to a treatment and changes its status to active
type AssignTreatmentService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s AssignTreatmentService) Execute(id string, patientID string) error <span class="cov8" title="1">{

        treatment := models.Treatment{}

        patientInOtherTreatment := models.Treatment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"patientId": patientID, "status": string(models.Active)}, &amp;patientInOtherTreatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if patientInOtherTreatment.ID != "" </span><span class="cov8" title="1">{
                return errors.New("patient is already in an active treatment")
        }</span>

        <span class="cov8" title="1">findErr = s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"id": id}, &amp;treatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if treatment.ID == "" </span><span class="cov0" title="0">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">if treatment.Status != models.Pending </span><span class="cov8" title="1">{
                return fmt.Errorf("treatments can only be assigned if their current status is PENDING. current status is %s", string(treatment.Status))
        }</span>

        <span class="cov8" title="1">treatment.PatientID = patientID
        treatment.StartDate = time.Now().Unix()
        treatment.Status = models.Active

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "treatments", map[string]interface{}{"id": id}, treatment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file27" style="display: none">package services

import (
        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
)

// CreateTreatmentService is a service that creates a new treatment for a psychologist
type CreateTreatmentService struct {
        DatabaseUtil   database.IDatabaseUtil
        IdentifierUtil identifier.IIdentifierUtil
}

// Execute is the method that runs the business logic of the service
func (s CreateTreatmentService) Execute(psychologistID string, input models.CreateTreatmentInput) error <span class="cov8" title="1">{

        _, treatmentID, treatmentIDErr := s.IdentifierUtil.GenerateIdentifier()
        if treatmentIDErr != nil </span><span class="cov0" title="0">{
                return treatmentIDErr
        }</span>

        <span class="cov8" title="1">treatment := models.Treatment{
                ID:             treatmentID,
                PsychologistID: psychologistID,
                Duration:       input.Duration,
                Price:          input.Price,
                Interval:       input.Interval,
                Status:         models.Pending,
        }

        writeErr := s.DatabaseUtil.InsertOne("psi_db", "treatments", treatment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file28" style="display: none">package services

import (
        "errors"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// DeleteTreatmentService is a service that changes data from a treatment
type DeleteTreatmentService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s DeleteTreatmentService) Execute(id string, psychologistID string) error <span class="cov0" title="0">{

        treatment := models.Treatment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"id": id, "psychologistId": psychologistID}, &amp;treatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov0" title="0">if treatment.ID == "" </span><span class="cov0" title="0">{
                return errors.New("resource not found")
        }</span>

        <span class="cov0" title="0">if treatment.Status != models.Pending </span><span class="cov0" title="0">{
                return errors.New("treatments can only be deleted if they their status is pending")
        }</span>

        <span class="cov0" title="0">writeErr := s.DatabaseUtil.DeleteOne("psi_db", "treatments", map[string]interface{}{"id": id})
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov0" title="0">return nil</span>

}
</pre>
		
		<pre class="file" id="file29" style="display: none">package services

import (
        "errors"
        "fmt"
        "time"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// FinalizeTreatmentService is a service that changes the status of a treatment to finalized
type FinalizeTreatmentService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s FinalizeTreatmentService) Execute(id string, psychologistID string) error <span class="cov8" title="1">{

        treatment := models.Treatment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"id": id, "psychologistId": psychologistID}, &amp;treatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if treatment.ID == "" </span><span class="cov8" title="1">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">if treatment.Status != models.Active </span><span class="cov0" title="0">{
                return fmt.Errorf("treatments can only be finalized if their current status is ACTIVE. current status is %s", string(treatment.Status))
        }</span>

        <span class="cov8" title="1">treatment.EndDate = time.Now().Unix()
        treatment.Status = models.Finalized

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "treatments", map[string]interface{}{"id": id}, treatment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file30" style="display: none">package services

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
)

// GetPatientTreatmentsService is a service that gets all the treatments of a psychologist
type GetPatientTreatmentsService struct {
        DatabaseUtil   database.IDatabaseUtil
        IdentifierUtil identifier.IIdentifierUtil
}

// Execute is the method that runs the business logic of the service
func (s GetPatientTreatmentsService) Execute(patientID string) ([]*models.GetPatientTreatmentsResponse, error) <span class="cov0" title="0">{

        filter := map[string]interface{}{"patientId": patientID}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "treatments", filter)
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov0" title="0">treatments := []*models.GetPatientTreatmentsResponse{}

        defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov0" title="0">{

                treatment := models.GetPatientTreatmentsResponse{}

                decodeErr := cursor.Decode(&amp;treatment)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov0" title="0">treatments = append(treatments, &amp;treatment)</span>

        }

        <span class="cov0" title="0">return treatments, nil</span>

}
</pre>
		
		<pre class="file" id="file31" style="display: none">package services

import (
        "context"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
)

// GetPsychologistTreatmentsService is a service that gets all the treatments of a psychologist
type GetPsychologistTreatmentsService struct {
        DatabaseUtil   database.IDatabaseUtil
        IdentifierUtil identifier.IIdentifierUtil
}

// Execute is the method that runs the business logic of the service
func (s GetPsychologistTreatmentsService) Execute(psychologistID string) ([]*models.GetPsychologistTreatmentsResponse, error) <span class="cov8" title="1">{

        filter := map[string]interface{}{"psychologistId": psychologistID}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "treatments", filter)
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">treatments := []*models.GetPsychologistTreatmentsResponse{}

        defer cursor.Close(context.Background())

        for cursor.Next(context.Background()) </span><span class="cov8" title="1">{

                treatment := models.GetPsychologistTreatmentsResponse{}

                decodeErr := cursor.Decode(&amp;treatment)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov8" title="1">treatments = append(treatments, &amp;treatment)</span>

        }

        <span class="cov8" title="1">return treatments, nil</span>

}
</pre>
		
		<pre class="file" id="file32" style="display: none">package services

import (
        "errors"
        "fmt"
        "time"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// InterruptTreatmentByPatientService is a service that interrupts a treatment, changing its status to interrupted by patient
type InterruptTreatmentByPatientService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s InterruptTreatmentByPatientService) Execute(id string, patientID string, reason string) error <span class="cov8" title="1">{

        treatment := models.Treatment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"id": id, "patientId": patientID}, &amp;treatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if treatment.ID == "" </span><span class="cov8" title="1">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">if treatment.Status != models.Active </span><span class="cov0" title="0">{
                return fmt.Errorf("treatments can only be interrupted if their current status is ACTIVE. current status is %s", string(treatment.Status))
        }</span>

        <span class="cov8" title="1">treatment.EndDate = time.Now().Unix()
        treatment.Status = models.InterruptedByPatient
        treatment.Reason = reason

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "treatments", map[string]interface{}{"id": id}, treatment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file33" style="display: none">package services

import (
        "errors"
        "fmt"
        "time"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// InterruptTreatmentByPsychologistService is a service that interrupts a treatment, changing its status to interrupted by psychologist
type InterruptTreatmentByPsychologistService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s InterruptTreatmentByPsychologistService) Execute(id string, psychologistID string, reason string) error <span class="cov8" title="1">{

        treatment := models.Treatment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"id": id, "psychologistId": psychologistID}, &amp;treatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if treatment.ID == "" </span><span class="cov8" title="1">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">if treatment.Status != models.Active </span><span class="cov0" title="0">{
                return fmt.Errorf("treatments can only be interrupted if their current status is ACTIVE. current status is %s", string(treatment.Status))
        }</span>

        <span class="cov8" title="1">treatment.EndDate = time.Now().Unix()
        treatment.Status = models.InterruptedByPsychologist
        treatment.Reason = reason

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "treatments", map[string]interface{}{"id": id}, treatment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file34" style="display: none">package services

import (
        "errors"

        "github.com/guicostaarantes/psi-server/modules/treatments/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// UpdateTreatmentService is a service that changes data from a treatment
type UpdateTreatmentService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s UpdateTreatmentService) Execute(id string, psychologistID string, input models.UpdateTreatmentInput) error <span class="cov8" title="1">{

        treatment := models.Treatment{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "treatments", map[string]interface{}{"id": id, "psychologistId": psychologistID}, &amp;treatment)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if treatment.ID == "" </span><span class="cov8" title="1">{
                return errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">treatment.Duration = input.Duration
        treatment.Price = input.Price
        treatment.Interval = input.Interval

        writeErr := s.DatabaseUtil.UpdateOne("psi_db", "treatments", map[string]interface{}{"id": id}, treatment)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file35" style="display: none">package services

import (
        "bytes"
        "html/template"
        "os"
        "time"

        mails_models "github.com/guicostaarantes/psi-server/modules/mails/models"
        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/modules/users/templates"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
        "github.com/guicostaarantes/psi-server/utils/token"
)

// AskResetPasswordService is a service that sends a token to the user's email so that they can reset their password
type AskResetPasswordService struct {
        DatabaseUtil      database.IDatabaseUtil
        IdentifierUtil    identifier.IIdentifierUtil
        TokenUtil         token.ITokenUtil
        SecondsToCooldown int64
        SecondsToExpire   int64
}

// Execute is the method that runs the business logic of the service
func (s AskResetPasswordService) Execute(email string) error <span class="cov8" title="1">{

        user := &amp;models.User{}

        findUserErr := s.DatabaseUtil.FindOne("psi_db", "users", map[string]interface{}{"email": email}, user)
        if findUserErr != nil </span><span class="cov0" title="0">{
                return findUserErr
        }</span>

        <span class="cov8" title="1">if user.ID == "" || !user.Active </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov8" title="1">existsReset := &amp;models.ResetPassword{}

        findTokenErr := s.DatabaseUtil.FindOne("psi_db", "resets", map[string]interface{}{"userId": user.ID}, existsReset)
        if findTokenErr != nil </span><span class="cov0" title="0">{
                return findTokenErr
        }</span>

        <span class="cov8" title="1">if existsReset.UserID != "" &amp;&amp; existsReset.IssuedAt &gt; time.Now().Add(-time.Second*time.Duration(s.SecondsToCooldown)).Unix() </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov8" title="1">token, tokenErr := s.TokenUtil.GenerateToken(user.ID, s.SecondsToCooldown)
        if tokenErr != nil </span><span class="cov0" title="0">{
                return tokenErr
        }</span>

        <span class="cov8" title="1">reset := &amp;models.ResetPassword{
                UserID:    user.ID,
                IssuedAt:  time.Now().Unix(),
                ExpiresAt: time.Now().Add(time.Second * time.Duration(s.SecondsToCooldown)).Unix(),
                Token:     token,
                Redeemed:  false,
        }

        _, mailID, mailIDErr := s.IdentifierUtil.GenerateIdentifier()
        if mailIDErr != nil </span><span class="cov0" title="0">{
                return mailIDErr
        }</span>

        <span class="cov8" title="1">templ, templErr := template.New("ResetPasswordEmail").Parse(templates.ResetPasswordEmailTemplate)
        if templErr != nil </span><span class="cov0" title="0">{
                return templErr
        }</span>

        <span class="cov8" title="1">buff := new(bytes.Buffer)

        templ.Execute(buff, map[string]string{
                "SiteURL": os.Getenv("PSI_SITE_URL"),
                "Token":   token,
        })

        mail := &amp;mails_models.TransientMailMessage{
                ID:          mailID,
                FromAddress: "relacionamento@psi.com.br",
                FromName:    "Relacionamento PSI",
                To:          []string{user.Email},
                Cc:          []string{},
                Cco:         []string{},
                Subject:     "Redfinir senha do PSI",
                Html:        buff.String(),
                Processed:   false,
        }

        writeMailErr := s.DatabaseUtil.InsertOne("psi_db", "mails", mail)
        if writeMailErr != nil </span><span class="cov0" title="0">{
                return writeMailErr
        }</span>

        <span class="cov8" title="1">writeResetErr := s.DatabaseUtil.InsertOne("psi_db", "resets", reset)
        if writeResetErr != nil </span><span class="cov0" title="0">{
                return writeResetErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file36" style="display: none">package services

import (
        "errors"
        "time"

        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/hash"
        "github.com/guicostaarantes/psi-server/utils/serializing"
        "github.com/guicostaarantes/psi-server/utils/token"
)

// AuthenticateUserService is a service that exchanges credentials for an access token
type AuthenticateUserService struct {
        DatabaseUtil    database.IDatabaseUtil
        HashUtil        hash.IHashUtil
        SerializingUtil serializing.ISerializingUtil
        TokenUtil       token.ITokenUtil
        SecondsToExpire int64
}

// Execute is the method that runs the business logic of the service
func (s AuthenticateUserService) Execute(authInput *models.AuthenticateUserInput) (*models.Authentication, error) <span class="cov8" title="1">{

        if authInput.IPAddress == "" </span><span class="cov0" title="0">{
                return nil, errors.New("must notify IP")
        }</span>

        <span class="cov8" title="1">user := models.User{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "users", map[string]interface{}{"email": authInput.Email}, &amp;user)
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">if user.ID == "" || !user.Active </span><span class="cov8" title="1">{
                return nil, errors.New("incorrect credentials")
        }</span>

        <span class="cov8" title="1">compareErr := s.HashUtil.Compare(authInput.Password, user.Password)
        if compareErr != nil </span><span class="cov8" title="1">{
                if compareErr.Error() == s.HashUtil.GetWrongPasswordError() </span><span class="cov8" title="1">{
                        return nil, errors.New("incorrect credentials")
                }</span>
                <span class="cov0" title="0">return nil, compareErr</span>
        }

        <span class="cov8" title="1">token, tokenErr := s.TokenUtil.GenerateToken(user.ID, s.SecondsToExpire)
        if tokenErr != nil </span><span class="cov0" title="0">{
                return nil, tokenErr
        }</span>

        <span class="cov8" title="1">auth := &amp;models.Authentication{
                UserID:    user.ID,
                IPAddress: authInput.IPAddress,
                IssuedAt:  time.Now().Unix(),
                ExpiresAt: time.Now().Add(time.Second * time.Duration(s.SecondsToExpire)).Unix(),
                Token:     token,
        }

        deleteErr := s.DatabaseUtil.DeleteOne("psi_db", "auths", map[string]interface{}{"userId": auth.UserID})
        if deleteErr != nil </span><span class="cov0" title="0">{
                return nil, deleteErr
        }</span>

        <span class="cov8" title="1">writeErr := s.DatabaseUtil.InsertOne("psi_db", "auths", auth)
        if writeErr != nil </span><span class="cov0" title="0">{
                return nil, writeErr
        }</span>

        <span class="cov8" title="1">return auth, nil</span>

}
</pre>
		
		<pre class="file" id="file37" style="display: none">package services

import (
        "bytes"
        "errors"
        "html/template"
        "os"
        "time"

        mails_models "github.com/guicostaarantes/psi-server/modules/mails/models"
        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/modules/users/templates"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/identifier"
        "github.com/guicostaarantes/psi-server/utils/match"
        "github.com/guicostaarantes/psi-server/utils/serializing"
        "github.com/guicostaarantes/psi-server/utils/token"
)

// CreateUserService is a service that creates users and sends emails so that the owner can assign a password
type CreateUserService struct {
        DatabaseUtil    database.IDatabaseUtil
        IdentifierUtil  identifier.IIdentifierUtil
        MatchUtil       match.IMatchUtil
        SerializingUtil serializing.ISerializingUtil
        TokenUtil       token.ITokenUtil
        SecondsToExpire int64
}

// Execute is the method that runs the business logic of the service
func (s CreateUserService) Execute(userInput *models.CreateUserInput) error <span class="cov8" title="1">{

        emailErr := s.MatchUtil.IsEmailValid(userInput.Email)
        if emailErr != nil </span><span class="cov0" title="0">{
                return emailErr
        }</span>

        <span class="cov8" title="1">userWithSameEmail := models.User{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "users", map[string]interface{}{"email": userInput.Email}, &amp;userWithSameEmail)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if userWithSameEmail.ID != "" </span><span class="cov8" title="1">{
                return errors.New("user with same email already exists")
        }</span>

        <span class="cov8" title="1">_, userID, userIDErr := s.IdentifierUtil.GenerateIdentifier()
        if userIDErr != nil </span><span class="cov0" title="0">{
                return userIDErr
        }</span>

        <span class="cov8" title="1">user := &amp;models.User{
                ID:     userID,
                Active: true,
                Email:  userInput.Email,
                Role:   userInput.Role,
        }

        token, tokenErr := s.TokenUtil.GenerateToken(user.ID, s.SecondsToExpire)
        if tokenErr != nil </span><span class="cov0" title="0">{
                return tokenErr
        }</span>

        <span class="cov8" title="1">reset := &amp;models.ResetPassword{
                UserID:    userID,
                IssuedAt:  time.Now().Unix(),
                ExpiresAt: time.Now().Add(time.Second * time.Duration(s.SecondsToExpire)).Unix(),
                Token:     token,
                Redeemed:  false,
        }

        _, mailID, mailIDErr := s.IdentifierUtil.GenerateIdentifier()
        if mailIDErr != nil </span><span class="cov0" title="0">{
                return mailIDErr
        }</span>

        <span class="cov8" title="1">templ, templErr := template.New("CreateUserEmail").Parse(templates.CreateUserEmailTemplate)
        if templErr != nil </span><span class="cov0" title="0">{
                return templErr
        }</span>

        <span class="cov8" title="1">buff := new(bytes.Buffer)

        templ.Execute(buff, map[string]string{
                "SiteURL": os.Getenv("PSI_SITE_URL"),
                "Token":   token,
        })

        mail := &amp;mails_models.TransientMailMessage{
                ID:          mailID,
                FromAddress: "relacionamento@psi.com.br",
                FromName:    "Relacionamento PSI",
                To:          []string{user.Email},
                Cc:          []string{},
                Cco:         []string{},
                Subject:     "Bem-vindo ao PSI",
                Html:        buff.String(),
                Processed:   false,
        }

        writeMailErr := s.DatabaseUtil.InsertOne("psi_db", "mails", mail)
        if writeMailErr != nil </span><span class="cov0" title="0">{
                return writeMailErr
        }</span>

        <span class="cov8" title="1">writeResetErr := s.DatabaseUtil.InsertOne("psi_db", "resets", reset)
        if writeResetErr != nil </span><span class="cov0" title="0">{
                return writeResetErr
        }</span>

        <span class="cov8" title="1">writeUserErr := s.DatabaseUtil.InsertOne("psi_db", "users", user)
        if writeUserErr != nil </span><span class="cov0" title="0">{
                return writeUserErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file38" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/hash"
        "github.com/guicostaarantes/psi-server/utils/identifier"
        "github.com/guicostaarantes/psi-server/utils/match"
        "github.com/guicostaarantes/psi-server/utils/serializing"
)

// CreateUserWithPasswordService is a service that creates users and assigns them a password immediately
type CreateUserWithPasswordService struct {
        DatabaseUtil    database.IDatabaseUtil
        HashUtil        hash.IHashUtil
        IdentifierUtil  identifier.IIdentifierUtil
        MatchUtil       match.IMatchUtil
        SerializingUtil serializing.ISerializingUtil
}

// Execute is the method that runs the business logic of the service
func (s CreateUserWithPasswordService) Execute(userInput *models.CreateUserWithPasswordInput) error <span class="cov8" title="1">{

        emailErr := s.MatchUtil.IsEmailValid(userInput.Email)
        if emailErr != nil </span><span class="cov0" title="0">{
                return emailErr
        }</span>

        <span class="cov8" title="1">passwordErr := s.MatchUtil.IsPasswordStrong(userInput.Password)
        if passwordErr != nil </span><span class="cov0" title="0">{
                return passwordErr
        }</span>

        <span class="cov8" title="1">userWithSameEmail := models.User{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "users", map[string]interface{}{"email": userInput.Email}, &amp;userWithSameEmail)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov8" title="1">if userWithSameEmail.ID != "" </span><span class="cov0" title="0">{
                return errors.New("user with same email already exists")
        }</span>

        <span class="cov8" title="1">_, id, idErr := s.IdentifierUtil.GenerateIdentifier()
        if idErr != nil </span><span class="cov0" title="0">{
                return idErr
        }</span>

        <span class="cov8" title="1">hashedPwd, hashErr := s.HashUtil.Hash(userInput.Password)
        if hashErr != nil </span><span class="cov0" title="0">{
                return hashErr
        }</span>

        <span class="cov8" title="1">user := &amp;models.User{
                ID:     id,
                Active: true,
                Email:  userInput.Email,
                Role:   userInput.Role,
        }

        user.Password = hashedPwd

        writeErr := s.DatabaseUtil.InsertOne("psi_db", "users", user)
        if writeErr != nil </span><span class="cov0" title="0">{
                return writeErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file39" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetUserByIDService is a service that gets the user by userId
type GetUserByIDService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetUserByIDService) Execute(id string) (*models.User, error) <span class="cov8" title="1">{

        user := &amp;models.User{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "users", map[string]interface{}{"id": id}, user)
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov8" title="1">if user.ID == "" </span><span class="cov0" title="0">{
                return nil, errors.New("resource not found")
        }</span>

        <span class="cov8" title="1">return user, nil</span>

}
</pre>
		
		<pre class="file" id="file40" style="display: none">package services

import (
        "context"
        "time"

        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// GetUsersByRoleService is a service that gets the all users of a specific role in the database
type GetUsersByRoleService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s GetUsersByRoleService) Execute(role string) ([]*models.User, error) <span class="cov0" title="0">{

        ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)

        defer cancel()

        users := []*models.User{}

        cursor, findErr := s.DatabaseUtil.FindMany("psi_db", "users", map[string]interface{}{"role": role})
        if findErr != nil </span><span class="cov0" title="0">{
                return nil, findErr
        }</span>

        <span class="cov0" title="0">defer cursor.Close(ctx)

        for cursor.Next(ctx) </span><span class="cov0" title="0">{
                user := &amp;models.User{}

                decodeErr := cursor.Decode(user)
                if decodeErr != nil </span><span class="cov0" title="0">{
                        return nil, decodeErr
                }</span>

                <span class="cov0" title="0">users = append(users, user)</span>
        }

        <span class="cov0" title="0">return users, nil</span>

}
</pre>
		
		<pre class="file" id="file41" style="display: none">package services

import (
        "errors"
        "time"

        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/hash"
        "github.com/guicostaarantes/psi-server/utils/match"
)

// ResetPasswordService is a service that (re)sets the password for a user based on a token sent to their email
type ResetPasswordService struct {
        DatabaseUtil database.IDatabaseUtil
        MatchUtil    match.IMatchUtil
        HashUtil     hash.IHashUtil
}

// Execute is the method that runs the business logic of the service
func (s ResetPasswordService) Execute(resetInput *models.ResetPasswordInput) error <span class="cov8" title="1">{

        passwordErr := s.MatchUtil.IsPasswordStrong(resetInput.Password)
        if passwordErr != nil </span><span class="cov0" title="0">{
                return passwordErr
        }</span>

        <span class="cov8" title="1">reset := &amp;models.ResetPassword{}

        findTokenErr := s.DatabaseUtil.FindOne("psi_db", "resets", map[string]interface{}{"token": resetInput.Token}, reset)
        if findTokenErr != nil </span><span class="cov0" title="0">{
                return findTokenErr
        }</span>

        <span class="cov8" title="1">if reset.UserID == "" || reset.ExpiresAt &lt; time.Now().Unix() || reset.Redeemed </span><span class="cov0" title="0">{
                return errors.New("invalid token")
        }</span>

        <span class="cov8" title="1">user := &amp;models.User{}

        findUserErr := s.DatabaseUtil.FindOne("psi_db", "users", map[string]interface{}{"id": reset.UserID}, user)
        if findUserErr != nil </span><span class="cov0" title="0">{
                return findUserErr
        }</span>

        <span class="cov8" title="1">if user.ID == "" || !user.Active </span><span class="cov0" title="0">{
                return errors.New("invalid token")
        }</span>

        <span class="cov8" title="1">hashedPwd, hashErr := s.HashUtil.Hash(resetInput.Password)
        if hashErr != nil </span><span class="cov0" title="0">{
                return hashErr
        }</span>

        <span class="cov8" title="1">user.Password = hashedPwd

        updateUserErr := s.DatabaseUtil.UpdateOne("psi_db", "users", map[string]interface{}{"id": reset.UserID}, user)
        if updateUserErr != nil </span><span class="cov0" title="0">{
                return updateUserErr
        }</span>

        <span class="cov8" title="1">reset.Redeemed = true

        expireTokenErr := s.DatabaseUtil.UpdateOne("psi_db", "resets", map[string]interface{}{"token": resetInput.Token}, reset)
        if expireTokenErr != nil </span><span class="cov0" title="0">{
                return expireTokenErr
        }</span>

        <span class="cov8" title="1">return nil</span>

}
</pre>
		
		<pre class="file" id="file42" style="display: none">package services

import (
        "errors"

        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/utils/database"
)

// UpdateUserService is a service that can change data from a user
type UpdateUserService struct {
        DatabaseUtil database.IDatabaseUtil
}

// Execute is the method that runs the business logic of the service
func (s UpdateUserService) Execute(userID string, input *models.UpdateUserInput) error <span class="cov0" title="0">{

        user := models.User{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "users", map[string]interface{}{"id": userID}, &amp;user)
        if findErr != nil </span><span class="cov0" title="0">{
                return findErr
        }</span>

        <span class="cov0" title="0">if user.ID == "" </span><span class="cov0" title="0">{
                return errors.New("resource not found")
        }</span>

        <span class="cov0" title="0">user.Active = input.Active
        user.Role = input.Role

        updateErr := s.DatabaseUtil.UpdateOne("psi_db", "users", map[string]interface{}{"id": userID}, user)
        if updateErr != nil </span><span class="cov0" title="0">{
                return updateErr
        }</span>

        <span class="cov0" title="0">return nil</span>

}
</pre>
		
		<pre class="file" id="file43" style="display: none">package services

import (
        "errors"
        "time"

        models "github.com/guicostaarantes/psi-server/modules/users/models"
        "github.com/guicostaarantes/psi-server/utils/database"
        "github.com/guicostaarantes/psi-server/utils/serializing"
)

// ValidateUserTokenService is a service that checks the validity of a token
type ValidateUserTokenService struct {
        DatabaseUtil    database.IDatabaseUtil
        SerializingUtil serializing.ISerializingUtil
        SecondsToExpire int64
}

// Execute is the method that runs the business logic of the service
func (s ValidateUserTokenService) Execute(token string) (string, error) <span class="cov8" title="1">{

        auth := models.Authentication{}

        findErr := s.DatabaseUtil.FindOne("psi_db", "auths", map[string]interface{}{"token": token}, &amp;auth)
        if findErr != nil </span><span class="cov0" title="0">{
                return "", findErr
        }</span>

        <span class="cov8" title="1">if auth.UserID == "" || auth.ExpiresAt &lt; time.Now().Unix() </span><span class="cov0" title="0">{
                return "", errors.New("invalid token")
        }</span>

        <span class="cov8" title="1">auth.ExpiresAt = time.Now().Unix() + s.SecondsToExpire

        updateErr := s.DatabaseUtil.UpdateOne("psi_db", "auths", map[string]interface{}{"token": token}, auth)
        if updateErr != nil </span><span class="cov0" title="0">{
                return "", updateErr
        }</span>

        <span class="cov8" title="1">return auth.UserID, nil</span>

}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
